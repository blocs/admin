---
description: テーブルタイプの入力画面の作り方
globs: **/*.php, **/*.blocs.html, **/*.html
alwaysApply: false
---
# テーブルタイプの入力画面の作り方
## テーブルタイプの入力画面
複数のレコード（データ）を一度に入力できる画面を「テーブルタイプの入力画面」と呼びます。大量のデータをまとめて入力したい場合にとても便利です。

## 入力フォームのテンプレートを作成する
テーブルタイプの入力画面は、`data-loop` 属性を使って作成します。
まず、1件分の入力フォームのテンプレートを作成し、それを `data-loop` で囲むことで、複数件の入力が可能になります。
```html
    <tbody data-loop=$books>
        <tr>
            <th>
                <label for="name">名前</label> *
            </th>
            <td>
                <input type='text' class='form-control' value='' id="name" name="name" required />
            </td>
        </tr>
```
このように、`<tbody>` タグに `data-loop` 属性を付けることで、`$books` のデータ件数分、入力行が繰り返し表示されます。

## バリデーション条件を設定する
バリデーションでは、ワイルドカード（*）を使って複数の入力項目を一括で指定できます。テーブルタイプの入力フォームでは、各入力値が配列として扱われるため、エラーメッセージを表示する際には、現在のループのインデックス（`$loop->index`）を使って添字を指定する必要があります。
```html
<!-- !books.*.name='required_with:books.*.price' data-lang='価格を入力してください' --> 
@error("books.".$loop->index.".name") <div class="invalid-feedback">{{ $message }}</div> @enderror
```
この例では、`books.*.name` に対して「`books.*.price` が入力されている場合は必須」というバリデーションルールを設定しています。エラーが発生した場合は、該当する行にエラーメッセージが表示されます。

## コントローラーで初期データを作成する
テーブルタイプの入力フォームを表示するには、コントローラー側で初期データを用意しておく必要があります。初期データがないと、画面に入力フォームが表示されません。以下のように記述することで、初期状態で2件分の空の入力フォームを表示できます。
```php
    protected function prepareCreate()
    {
        old('books') || $this->val['books'] = [[], []];
    }
```
このコードは、過去の入力（`old('books')`）が存在しない場合に、空のレコードを2件分用意する処理です。

## 入力フォームからの値を登録する
テーブルタイプの入力フォームでは、複数件の入力値が配列として送信されます。そのため、コントローラーやモデルでデータを登録する際は、配列をループ処理して1件ずつ保存します。
```php
foreach (request()->books as $book) {
    $company->histories()->create([
        'date' => $book['date'],
        'event' => $book['event'],
    ]);
}
```

このコードでは、`request()->books` で送信された配列データを1件ずつ取り出し、`histories()` 関連モデルに対して `create()` メソッドで登録しています。
